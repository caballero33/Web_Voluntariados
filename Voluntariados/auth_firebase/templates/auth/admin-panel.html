{% extends 'base.html' %}
{% load static %}

<!-- Forzar recarga de cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

{% block title %}Panel de Administraci√≥n - Campus Voluntariados{% endblock %}

{% block content %}
<div class="admin-panel-container">
    <!-- Header del Panel -->
    <div class="panel-header">
        <div class="header-content">
            <div class="header-info">
                <h1 class="title is-2">
                    <span class="icon"><i class="fas fa-crown"></i></span>
                    Panel de Administraci√≥n
                </h1>
                <p class="subtitle is-5">Gestiona tu voluntariado y supervisa a los miembros</p>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="total-members">0</span>
                        <span class="stat-label">Miembros</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="total-events">0</span>
                        <span class="stat-label">Eventos</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-number" id="total-hours">0</span>
                        <span class="stat-label">Horas</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de Voluntariado -->
    <div class="volunteer-selector">
        <div class="field is-grouped">
            <div class="control is-expanded">
                <div class="select is-large">
                    <select id="volunteer-select">
                        <option value="">Selecciona un voluntariado...</option>
                    </select>
                </div>
            </div>
            <div class="control">
                <button class="button is-primary is-large" onclick="loadVolunteerData()">
                    <span class="icon"><i class="fas fa-search"></i></span>
                    <span>Cargar Datos</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="panel-content" id="panel-content" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tabs is-centered is-fullwidth is-large">
            <ul>
                <li class="is-active" data-tab="members">
                    <a>
                        <span class="icon"><i class="fas fa-users"></i></span>
                        <span>Miembros</span>
                    </a>
                </li>
                <li data-tab="statistics">
                    <a>
                        <span class="icon"><i class="fas fa-chart-bar"></i></span>
                        <span>Estad√≠sticas</span>
                    </a>
                </li>
                <li data-tab="hours">
                    <a>
                        <span class="icon"><i class="fas fa-clock"></i></span>
                        <span>Gesti√≥n de Horas</span>
                    </a>
                </li>
                <li data-tab="achievements">
                    <a>
                        <span class="icon"><i class="fas fa-trophy"></i></span>
                        <span>Logros</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Contenido de las Pesta√±as -->
        
        <!-- Pesta√±a Miembros -->
        <div id="members-content" class="tab-content">
            <div class="members-header">
                <h2 class="title is-4">
                    <span class="icon"><i class="fas fa-users"></i></span>
                    Miembros del Voluntariado
                </h2>
                <div class="members-actions">
                    <button class="button is-info" onclick="exportMembersData()">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Exportar Datos</span>
                    </button>
                </div>
            </div>
            
            <div class="members-list" id="members-list">
                <!-- Los miembros se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Pesta√±a Estad√≠sticas -->
        <div id="statistics-content" class="tab-content" style="display: none;">
            <div class="statistics-header">
                <h2 class="title is-4">
                    <span class="icon"><i class="fas fa-chart-bar"></i></span>
                    Estad√≠sticas Generales
                </h2>
            </div>
            
            <div class="charts-grid">
                <!-- Gr√°fico de Participaci√≥n en Eventos -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="title is-5">Participaci√≥n en Eventos</h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="eventsChart"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico de Horas por Mes -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="title is-5">Horas Voluntariadas por Mes</h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico de Miembros Activos -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="title is-5">Miembros M√°s Activos</h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="activeMembersChart"></canvas>
                    </div>
                </div>

                <!-- Tabla de Estad√≠sticas Detalladas -->
                <div class="chart-container full-width">
                    <div class="chart-header">
                        <h3 class="title is-5">Resumen Detallado</h3>
                    </div>
                    <div class="chart-content">
                        <div class="table-container">
                            <table class="table is-fullwidth is-striped">
                                <thead>
                                    <tr>
                                        <th>Miembro</th>
                                        <th>Eventos Participados</th>
                                        <th>Horas Totales</th>
                                        <th>√öltimo Evento</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="detailed-stats-table">
                                    <!-- Los datos se cargar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a Gesti√≥n de Horas -->
        <div id="hours-content" class="tab-content" style="display: none;">
            <div class="hours-header">
                <h2 class="title is-4">
                    <span class="icon"><i class="fas fa-clock"></i></span>
                    Gesti√≥n de Horas
                </h2>
                <div class="hours-actions">
                    <button class="button is-success" onclick="showAddHoursModal()">
                        <span class="icon"><i class="fas fa-plus"></i></span>
                        <span>Agregar Horas</span>
                    </button>
                </div>
            </div>
            
            <div class="hours-list" id="hours-list">
                <!-- La lista de horas se cargar√° aqu√≠ -->
            </div>
        </div>

        <!-- Pesta√±a Logros -->
        <div id="achievements-content" class="tab-content" style="display: none;">
            <div class="achievements-header">
                <h2 class="title is-4">
                    <span class="icon"><i class="fas fa-trophy"></i></span>
                    Sistema de Logros
                </h2>
                <div class="achievements-actions">
                    <button class="button is-warning" onclick="showCreateAchievementModal()">
                        <span class="icon"><i class="fas fa-plus"></i></span>
                        <span>Crear Logro</span>
                    </button>
                    <button class="button is-info is-outlined" onclick="window.debugAdminPanel()">
                        <span class="icon"><i class="fas fa-bug"></i></span>
                        <span>Debug</span>
                    </button>
                </div>
            </div>
            
            <div class="achievements-grid" id="achievements-grid">
                <!-- Los logros se cargar√°n aqu√≠ -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Horas -->
<div class="modal" id="add-hours-modal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Agregar Horas a Miembro</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="add-hours-form">
                <div class="field">
                    <label class="label">Miembro</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="hours-member-select" required>
                                <option value="">Selecciona un miembro...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Evento</label>
                    <div class="control">
                        <input class="input" type="text" id="hours-event" placeholder="Nombre del evento" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Horas</label>
                    <div class="control">
                        <input class="input" type="number" id="hours-amount" min="0.5" step="0.5" placeholder="2.5" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Fecha</label>
                    <div class="control">
                        <input class="input" type="date" id="hours-date" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Comentarios (Opcional)</label>
                    <div class="control">
                        <textarea class="textarea" id="hours-comments" rows="3" placeholder="Comentarios adicionales..."></textarea>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="addHours()">
                <span class="icon"><i class="fas fa-save"></i></span>
                <span>Agregar Horas</span>
            </button>
            <button class="button" onclick="closeModal()">Cancelar</button>
        </footer>
    </div>
</div>

<!-- Modal para Crear Logro -->
<div class="modal" id="create-achievement-modal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Crear Nuevo Logro</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="create-achievement-form">
                <div class="field">
                    <label class="label">Nombre del Logro</label>
                    <div class="control">
                        <input class="input" type="text" id="achievement-name" placeholder="Ej: Voluntario Estrella" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Descripci√≥n</label>
                    <div class="control">
                        <textarea class="textarea" id="achievement-description" rows="3" placeholder="Descripci√≥n del logro..." required></textarea>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Criterio</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="achievement-criteria" required>
                                <option value="">Selecciona un criterio...</option>
                                <option value="hours">Horas Voluntariadas</option>
                                <option value="events">Eventos Participados</option>
                                <option value="months">Meses Activo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Valor Requerido</label>
                    <div class="control">
                        <input class="input" type="number" id="achievement-value" min="1" placeholder="10" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Horas del Logro</label>
                    <div class="control">
                        <input class="input" type="number" id="achievement-hours" min="0" placeholder="5" value="0">
                    </div>
                    <p class="help">N√∫mero de horas que se otorgar√°n al miembro al asignar este logro</p>
                </div>
                <div class="field">
                    <label class="label">Icono (FontAwesome)</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="achievement-icon">
                                <option value="fas fa-trophy">üèÜ Trophy</option>
                                <option value="fas fa-star">‚≠ê Star</option>
                                <option value="fas fa-medal">ü•á Medal</option>
                                <option value="fas fa-award">üèÖ Award</option>
                                <option value="fas fa-certificate">üìú Certificate</option>
                                <option value="fas fa-heart">‚ù§Ô∏è Heart</option>
                                <option value="fas fa-hands-helping">ü§ù Helping Hands</option>
                                <option value="fas fa-leaf">üçÉ Leaf</option>
                                <option value="fas fa-globe">üåç Globe</option>
                                <option value="fas fa-graduation-cap">üéì Graduation</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="createAchievement()">
                <span class="icon"><i class="fas fa-save"></i></span>
                <span>Crear Logro</span>
            </button>
            <button class="button" onclick="closeModal()">Cancelar</button>
        </footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentVolunteerId = '';
let membersData = [];
let eventsData = [];
let achievementsData = [];

// Inicializar panel
document.addEventListener('DOMContentLoaded', function() {
    initializeAdminPanel();
});

async function initializeAdminPanel() {
    console.log('üîÑ Inicializando panel de administraci√≥n...');
    
    // Esperar a que Firebase est√© listo
    if (!window.firebaseAuth || !window.firebaseDb) {
        console.log('‚è≥ Firebase no est√° listo, reintentando...');
        setTimeout(initializeAdminPanel, 1000);
        return;
    }

    const user = window.firebaseAuth.currentUser;
    if (!user) {
        console.log('‚ùå Usuario no autenticado');
        showMessage('Debes iniciar sesi√≥n para acceder al panel de administraci√≥n', 'danger');
        return;
    }

    // Cargar voluntariados del admin
    await loadAdminVolunteers();
    
    // Configurar pesta√±as
    setupTabs();
    
    console.log('‚úÖ Panel de administraci√≥n inicializado');
}

async function loadAdminVolunteers() {
    try {
        const userDoc = await window.firebaseDb.collection('users').doc(window.firebaseAuth.currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData || !userData.adminVoluntariados || userData.adminVoluntariados.length === 0) {
            showMessage('No tienes permisos de administrador en ning√∫n voluntariado', 'warning');
            return;
        }

        const volunteerSelect = document.getElementById('volunteer-select');
        volunteerSelect.innerHTML = '<option value="">Selecciona un voluntariado...</option>';
        
        for (const voluntariadoId of userData.adminVoluntariados) {
            const voluntariadoDoc = await window.firebaseDb.collection('voluntariados').doc(voluntariadoId).get();
            const voluntariadoData = voluntariadoDoc.data();
            
            if (voluntariadoData) {
                const option = document.createElement('option');
                option.value = voluntariadoId;
                option.textContent = voluntariadoData.name || voluntariadoId;
                volunteerSelect.appendChild(option);
            }
        }
    } catch (error) {
        console.error('Error loading admin volunteers:', error);
        showMessage('Error al cargar voluntariados', 'danger');
    }
}

function setupTabs() {
    const tabs = document.querySelectorAll('.tabs li');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remover clase activa de todas las pesta√±as
            tabs.forEach(t => t.classList.remove('is-active'));
            tabContents.forEach(content => content.style.display = 'none');
            
            // Activar pesta√±a seleccionada
            tab.classList.add('is-active');
            const tabName = tab.dataset.tab;
            document.getElementById(`${tabName}-content`).style.display = 'block';
            
            // Cargar contenido espec√≠fico de la pesta√±a
            switch(tabName) {
                case 'members':
                    loadMembersData();
                    break;
                case 'statistics':
                    loadStatisticsData();
                    break;
                case 'hours':
                    loadHoursData();
                    break;
                case 'achievements':
                    loadAchievementsData();
                    break;
            }
        });
    });
}

async function loadVolunteerData() {
    const volunteerSelect = document.getElementById('volunteer-select');
    currentVolunteerId = volunteerSelect.value;
    
    if (!currentVolunteerId) {
        showMessage('Por favor selecciona un voluntariado', 'warning');
        return;
    }
    
    console.log('üîÑ Cargando datos del voluntariado:', currentVolunteerId);
    
    try {
        // Mostrar contenido del panel
        document.getElementById('panel-content').style.display = 'block';
        
        // Cargar datos generales
        await loadGeneralStats();
        
        // Cargar datos de miembros por defecto
        await loadMembersData();
        
        showMessage('Datos cargados exitosamente', 'success');
    } catch (error) {
        console.error('Error loading volunteer data:', error);
        showMessage('Error al cargar datos del voluntariado', 'danger');
    }
}

async function loadGeneralStats() {
    try {
        // Usar la nueva funci√≥n de estad√≠sticas del AdminManager
        const stats = await window.adminManager.getVolunteerStatistics(currentVolunteerId);
        
        // Actualizar estad√≠sticas generales
        document.getElementById('total-members').textContent = stats.totalMembers;
        document.getElementById('total-events').textContent = stats.totalEvents;
        document.getElementById('total-hours').textContent = stats.totalHours;
        
        // Guardar datos para uso posterior
        membersData = stats.membersByActivity;
        eventsData = stats.eventParticipation;
        
    } catch (error) {
        console.error('Error loading general stats:', error);
        showMessage('Error al cargar estad√≠sticas', 'danger');
    }
}

async function loadMembersData() {
    if (!currentVolunteerId) return;
    
    try {
        console.log('üîÑ Cargando miembros del voluntariado:', currentVolunteerId);
        
        // Obtener miembros directamente usando AdminManager
        const members = await window.adminManager.getVoluntariadoMembers(currentVolunteerId);
        console.log('üìä Miembros obtenidos:', members);
        
        const membersList = document.getElementById('members-list');
        
        if (!members || members.length === 0) {
            membersList.innerHTML = `
                <div class="has-text-centered py-6">
                    <i class="fas fa-users fa-3x has-text-grey-light"></i>
                    <p class="has-text-grey mt-3">No hay miembros en este voluntariado</p>
                </div>
            `;
            return;
        }
        
        membersList.innerHTML = members.map(member => {
            const volunteerData = member.voluntariadoData || {};
            const eventsCompleted = volunteerData.eventsCompleted || 0;
            const totalHours = volunteerData.totalHours || 0;
            const joinedDate = volunteerData.joinedDate ? volunteerData.joinedDate.toDate() : new Date();
            
            return `
                <div class="member-card">
                    <div class="member-info">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="member-details">
                            <h4 class="title is-5">${member.firstName || ''} ${member.lastName || ''}</h4>
                            <p class="subtitle is-6">${member.email}</p>
                            <div class="member-stats">
                                <span class="tag is-primary">${eventsCompleted} eventos</span>
                                <span class="tag is-info">${totalHours}h</span>
                                <span class="tag is-light">Miembro desde ${joinedDate.toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="button is-small is-info" onclick="viewMemberDetails('${member.uid}')">
                            <span class="icon"><i class="fas fa-eye"></i></span>
                            <span>Ver Detalles</span>
                        </button>
                        <button class="button is-small is-success" onclick="addHoursToMember('${member.uid}')">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Agregar Horas</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Guardar miembros para uso posterior
        membersData = members;
        
    } catch (error) {
        console.error('‚ùå Error loading members data:', error);
        showMessage('Error al cargar miembros: ' + error.message, 'danger');
    }
}

async function loadStatisticsData() {
    if (!currentVolunteerId) return;
    
    try {
        // Crear gr√°ficos
        createEventsChart();
        await createHoursChart(); // Ahora es async
        createActiveMembersChart();
        createDetailedStatsTable();
        
    } catch (error) {
        console.error('Error loading statistics data:', error);
    }
}

function createEventsChart() {
    const ctx = document.getElementById('eventsChart').getContext('2d');
    
    // Usar datos reales
    const eventParticipation = eventsData.slice(0, 10).map(event => ({
        name: event.title,
        participants: event.participants || 0
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: eventParticipation.map(e => e.name),
            datasets: [{
                label: 'Participantes',
                data: eventParticipation.map(e => e.participants),
                backgroundColor: '#2989d8',
                borderColor: '#18559b',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Participaci√≥n por Evento'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

async function createHoursChart() {
    try {
        const ctx = document.getElementById('hoursChart').getContext('2d');
        
        // Verificar que AdminManager est√© disponible
        if (!window.adminManager || typeof window.adminManager.getHoursByActivity !== 'function') {
            console.error('‚ùå AdminManager o getHoursByActivity no est√° disponible');
            ctx.canvas.parentElement.innerHTML = `
                <div class="has-text-centered py-6">
                    <i class="fas fa-exclamation-triangle fa-3x has-text-warning"></i>
                    <p class="has-text-grey mt-3">Error: AdminManager no est√° disponible</p>
                </div>
            `;
            return;
        }
        
        // Obtener datos reales de actividades
        const activitiesData = await window.adminManager.getHoursByActivity(currentVolunteerId);
        
        if (!activitiesData || activitiesData.length === 0) {
            // Mostrar mensaje si no hay datos
            ctx.canvas.parentElement.innerHTML = `
                <div class="has-text-centered py-6">
                    <i class="fas fa-chart-line fa-3x has-text-grey-light"></i>
                    <p class="has-text-grey mt-3">No hay datos de horas por actividad</p>
                </div>
            `;
            return;
        }
        
        // Tomar las primeras 8 actividades para el gr√°fico
        const topActivities = activitiesData.slice(0, 8);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topActivities.map(a => a.name),
                datasets: [{
                    label: 'Horas por Actividad',
                    data: topActivities.map(a => a.totalHours),
                    backgroundColor: [
                        '#2989d8',
                        '#28a745',
                        '#ffc107',
                        '#dc3545',
                        '#6f42c1',
                        '#20c997',
                        '#fd7e14',
                        '#6c757d'
                    ],
                    borderColor: [
                        '#18559b',
                        '#1e7e34',
                        '#e0a800',
                        '#bd2130',
                        '#5a32a3',
                        '#1aa179',
                        '#e8650e',
                        '#545b62'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Horas Voluntariadas por Actividad'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const activity = topActivities[context.dataIndex];
                                return `Participantes: ${activity.participantCount}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Horas Totales'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Actividades'
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error creando gr√°fico de horas:', error);
        const ctx = document.getElementById('hoursChart').getContext('2d');
        ctx.canvas.parentElement.innerHTML = `
            <div class="has-text-centered py-6">
                <i class="fas fa-exclamation-triangle fa-3x has-text-warning"></i>
                <p class="has-text-grey mt-3">Error al cargar datos del gr√°fico</p>
            </div>
        `;
    }
}

function createActiveMembersChart() {
    const ctx = document.getElementById('activeMembersChart').getContext('2d');
    
    // Verificar que membersData existe y tiene datos
    if (!membersData || membersData.length === 0) {
        ctx.canvas.parentElement.innerHTML = `
            <div class="has-text-centered py-6">
                <i class="fas fa-users fa-3x has-text-grey-light"></i>
                <p class="has-text-grey mt-3">No hay datos de miembros disponibles</p>
            </div>
        `;
        return;
    }
    
    // Datos de ejemplo - reemplazar con datos reales
    const activeMembers = membersData.slice(0, 5).map(member => {
        const volunteerData = member.voluntariadoData || member.voluntariados?.[currentVolunteerId] || {};
        return {
            name: `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email,
            hours: volunteerData.totalHours || 0
        };
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: activeMembers.map(m => m.name),
            datasets: [{
                data: activeMembers.map(m => m.hours),
                backgroundColor: [
                    '#2989d8',
                    '#18559b',
                    '#3498db',
                    '#5dade2',
                    '#85c1e9'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Top 5 Miembros M√°s Activos'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createDetailedStatsTable() {
    const tableBody = document.getElementById('detailed-stats-table');
    
    tableBody.innerHTML = membersData.map(member => {
        const volunteerData = member.voluntariados[currentVolunteerId] || {};
        const eventsCompleted = volunteerData.eventsCompleted || 0;
        const totalHours = volunteerData.totalHours || 0;
        const lastEvent = volunteerData.lastEventDate ? volunteerData.lastEventDate.toDate() : null;
        const status = eventsCompleted > 0 ? 'Activo' : 'Inactivo';
        
        return `
            <tr>
                <td>
                    <strong>${member.firstName || ''} ${member.lastName || ''}</strong><br>
                    <small class="has-text-grey">${member.email}</small>
                </td>
                <td><span class="tag is-primary">${eventsCompleted}</span></td>
                <td><span class="tag is-info">${totalHours}h</span></td>
                <td>${lastEvent ? lastEvent.toLocaleDateString() : 'Nunca'}</td>
                <td>
                    <span class="tag is-${status === 'Activo' ? 'success' : 'warning'}">${status}</span>
                </td>
            </tr>
        `;
    }).join('');
}

async function loadHoursData() {
    if (!currentVolunteerId) return;
    
    try {
        console.log('üîÑ Cargando datos de horas del voluntariado:', currentVolunteerId);
        
        const hoursList = document.getElementById('hours-list');
        
        // Obtener miembros para mostrar sus horas
        const members = await window.adminManager.getVoluntariadoMembers(currentVolunteerId);
        
        if (!members || members.length === 0) {
            hoursList.innerHTML = `
                <div class="has-text-centered py-6">
                    <i class="fas fa-clock fa-3x has-text-grey-light"></i>
                    <p class="has-text-grey mt-3">No hay miembros en este voluntariado</p>
                </div>
            `;
            return;
        }
        
        hoursList.innerHTML = members.map(member => {
            const volunteerData = member.voluntariadoData || {};
            const totalHours = volunteerData.totalHours || 0;
            const eventsCompleted = volunteerData.eventsCompleted || 0;
            const hoursHistory = volunteerData.hoursHistory || [];
            
            return `
                <div class="hours-member-card">
                    <div class="hours-member-info">
                        <div class="hours-member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="hours-member-details">
                            <h4 class="title is-5">${member.firstName || ''} ${member.lastName || ''}</h4>
                            <p class="subtitle is-6">${member.email}</p>
                            <div class="hours-member-stats">
                                <span class="tag is-primary is-large">${totalHours}h totales</span>
                                <span class="tag is-info">${eventsCompleted} eventos</span>
                            </div>
                        </div>
                    </div>
                    <div class="hours-member-actions">
                        <button class="button is-small is-success" onclick="showAddHoursModalForMember('${member.uid}')">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Agregar Horas</span>
                        </button>
                        <button class="button is-small is-info" onclick="viewHoursHistory('${member.uid}')">
                            <span class="icon"><i class="fas fa-history"></i></span>
                            <span>Ver Historial</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('‚ùå Error loading hours data:', error);
        showMessage('Error al cargar datos de horas: ' + error.message, 'danger');
    }
}

async function loadAchievementsData() {
    if (!currentVolunteerId) return;
    
    try {
        console.log('üîÑ Cargando logros para voluntariado:', currentVolunteerId);
        const achievementsGrid = document.getElementById('achievements-grid');
        
        // Obtener logros del voluntariado
        achievementsData = await window.adminManager.getVolunteerAchievements(currentVolunteerId);
        console.log('üìä Logros obtenidos:', achievementsData);
        
        if (!achievementsData || achievementsData.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron logros para el voluntariado:', currentVolunteerId);
            achievementsGrid.innerHTML = `
                <div class="has-text-centered py-6" style="grid-column: 1 / -1;">
                    <i class="fas fa-trophy fa-3x has-text-grey-light"></i>
                    <p class="has-text-grey mt-3">No hay logros creados para este voluntariado</p>
                    <p class="has-text-info">Crea el primer logro usando el bot√≥n "Crear Logro"</p>
                </div>
            `;
            return;
        }
        
        achievementsGrid.innerHTML = achievementsData.map(achievement => `
            <div class="achievement-card">
                <div class="achievement-header">
                    <div class="achievement-icon">
                        <i class="${achievement.icon || 'fas fa-trophy'} fa-2x has-text-warning"></i>
                    </div>
                    <div class="achievement-info">
                        <h4 class="title is-5">${achievement.name}</h4>
                        <p class="subtitle is-6">${achievement.description || 'Sin descripci√≥n'}</p>
                    </div>
                </div>
                <div class="achievement-details">
                    <div class="achievement-criteria">
                        <span class="tag is-info">${achievement.criteria || 'Requisitos'}: ${achievement.value || 'N/A'}</span>
                    </div>
                    <div class="achievement-meta">
                        <span class="tag ${achievement.isActive ? 'is-success' : 'is-danger'}">
                            ${achievement.isActive ? 'Activo' : 'Inactivo'}
                        </span>
                        <span class="has-text-grey">
                            ${achievement.createdAt ? achievement.createdAt.toDate().toLocaleDateString() : 'Sin fecha'}
                        </span>
                    </div>
                    <div class="achievement-actions">
                        <button class="button is-small is-info" onclick="viewAchievementDetails('${achievement.id}')">
                            <span class="icon"><i class="fas fa-eye"></i></span>
                            <span>Ver Detalles</span>
                        </button>
                        <button class="button is-small is-warning" onclick="assignAchievement('${achievement.id}')">
                            <span class="icon"><i class="fas fa-user-plus"></i></span>
                            <span>Asignar</span>
                        </button>
                        <button class="button is-small is-danger" onclick="deleteAchievement('${achievement.id}')">
                            <span class="icon"><i class="fas fa-trash"></i></span>
                            <span>Eliminar</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading achievements data:', error);
        showMessage('Error al cargar logros', 'danger');
    }
}

// Funciones de utilidad
function showMessage(message, type = 'info') {
    // Crear notificaci√≥n
    const notification = document.createElement('div');
    notification.className = `notification is-${type}`;
    notification.innerHTML = `
        <button class="delete" onclick="this.parentElement.remove()"></button>
        ${message}
    `;
    
    // Insertar al inicio del contenido
    const container = document.querySelector('.admin-panel-container');
    container.insertBefore(notification, container.firstChild);
    
    // Auto-remover despu√©s de 5 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function closeModal() {
    const modals = document.querySelectorAll('.modal.is-active');
    modals.forEach(modal => modal.classList.remove('is-active'));
}

async function showAddHoursModal() {
    document.getElementById('add-hours-modal').classList.add('is-active');
    
    // Si no hay datos de miembros, cargarlos
    if (!membersData || membersData.length === 0) {
        console.log('üîÑ Cargando datos de miembros para el modal...');
        try {
            await loadMembersData();
        } catch (error) {
            console.error('‚ùå Error cargando miembros:', error);
        }
    }
    
    populateMembersSelect();
    
    // Establecer fecha actual por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('hours-date').value = today;
}

function showCreateAchievementModal() {
    document.getElementById('create-achievement-modal').classList.add('is-active');
}

function populateMembersSelect() {
    const select = document.getElementById('hours-member-select');
    select.innerHTML = '<option value="">Selecciona un miembro...</option>';
    
    if (!membersData || membersData.length === 0) {
        console.log('‚ö†Ô∏è No hay datos de miembros para poblar el select');
        return;
    }
    
    membersData.forEach(member => {
        const option = document.createElement('option');
        option.value = member.uid || member.id; // Usar uid si est√° disponible
        option.textContent = `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email;
        select.appendChild(option);
    });
}

async function addHours() {
    try {
        console.log('üîÑ Agregando horas...');
        
        const memberId = document.getElementById('hours-member-select').value;
        const event = document.getElementById('hours-event').value.trim();
        const hours = parseFloat(document.getElementById('hours-amount').value);
        const date = document.getElementById('hours-date').value;
        const comments = document.getElementById('hours-comments').value.trim();
        
        if (!memberId || !event || !hours || !date || isNaN(hours)) {
            showMessage('Por favor completa todos los campos requeridos correctamente', 'warning');
            return;
        }
        
        if (!currentVolunteerId) {
            showMessage('No hay voluntariado seleccionado', 'warning');
            return;
        }
        
        console.log('üìä Datos de horas:', {
            memberId, event, hours, date, comments, voluntariadoId: currentVolunteerId
        });
        
        // Usar AdminManager para agregar horas
        const result = await window.adminManager.addHoursToMember(memberId, currentVolunteerId, {
            hours: hours,
            event: event,
            date: new Date(date),
            comments: comments
        });
        
        console.log('‚úÖ Horas agregadas:', result);
        showMessage('Horas agregadas exitosamente', 'success');
        closeModal();
        
        // Limpiar formulario
        document.getElementById('add-hours-form').reset();
        
        // Recargar datos
        await loadGeneralStats();
        await loadMembersData();
        
    } catch (error) {
        console.error('‚ùå Error adding hours:', error);
        showMessage('Error al agregar horas: ' + error.message, 'danger');
    }
}

async function createAchievement() {
    try {
        console.log('üîÑ Creando logro...');
        
        const name = document.getElementById('achievement-name').value.trim();
        const description = document.getElementById('achievement-description').value.trim();
        const criteria = document.getElementById('achievement-criteria').value;
        const value = parseInt(document.getElementById('achievement-value').value);
        const hours = parseInt(document.getElementById('achievement-hours').value) || 0;
        const icon = document.getElementById('achievement-icon').value || 'fas fa-trophy';
        
        if (!name || !description || !criteria || !value || isNaN(value)) {
            showMessage('Por favor completa todos los campos requeridos correctamente', 'warning');
            return;
        }
        
        if (!currentVolunteerId) {
            showMessage('No hay voluntariado seleccionado', 'warning');
            return;
        }
        
        console.log('üìä Datos del logro:', {
            name, description, criteria, value, hours, icon, voluntariadoId: currentVolunteerId
        });
        
        // Usar AdminManager para crear logro
        const result = await window.adminManager.createAchievement(currentVolunteerId, {
            name: name,
            description: description,
            criteria: criteria,
            value: value,
            hours: hours,
            icon: icon
        });
        
        console.log('‚úÖ Logro creado:', result);
        showMessage('Logro creado exitosamente', 'success');
        closeModal();
        
        // Limpiar formulario
        document.getElementById('create-achievement-form').reset();
        
        // Recargar datos
        await loadAchievementsData();
        
    } catch (error) {
        console.error('‚ùå Error creating achievement:', error);
        showMessage('Error al crear logro: ' + error.message, 'danger');
    }
}

function viewMemberDetails(memberId) {
    // Implementar vista de detalles del miembro
    console.log('Ver detalles del miembro:', memberId);
}

function addHoursToMember(memberId) {
    // Pre-seleccionar el miembro en el modal
    showAddHoursModal();
    setTimeout(() => {
        document.getElementById('hours-member-select').value = memberId;
    }, 100);
}

function showAddHoursModalForMember(memberId) {
    // Mostrar modal con miembro pre-seleccionado
    showAddHoursModal();
    setTimeout(() => {
        document.getElementById('hours-member-select').value = memberId;
    }, 100);
}

async function viewHoursHistory(memberId) {
    try {
        console.log('üîÑ Obteniendo historial de horas del miembro:', memberId);
        
        if (!currentVolunteerId) {
            showMessage('No hay voluntariado seleccionado', 'warning');
            return;
        }
        
        const historyData = await window.adminManager.getMemberHoursHistory(memberId, currentVolunteerId);
        
        // Crear modal para mostrar historial
        showHoursHistoryModal(historyData);
        
    } catch (error) {
        console.error('‚ùå Error obteniendo historial de horas:', error);
        showMessage('Error al obtener historial de horas: ' + error.message, 'danger');
    }
}

async function viewAchievementDetails(achievementId) {
    try {
        console.log('üîç Ver detalles del logro:', achievementId);
        
        if (!window.adminManager) {
            showMessage('AdminManager no est√° disponible', 'danger');
            return;
        }
        
        const achievementDetails = await window.adminManager.getAchievementDetails(achievementId);
        showAchievementDetailsModal(achievementDetails);
        
    } catch (error) {
        console.error('‚ùå Error obteniendo detalles del logro:', error);
        showMessage('Error al obtener detalles del logro: ' + error.message, 'danger');
    }
}

async function assignAchievement(achievementId) {
    try {
        console.log('üéØ Asignar logro:', achievementId);
        
        if (!currentVolunteerId) {
            showMessage('No hay voluntariado seleccionado', 'warning');
            return;
        }
        
        if (!window.adminManager) {
            showMessage('AdminManager no est√° disponible', 'danger');
            return;
        }
        
        // Obtener miembros del voluntariado
        const members = await window.adminManager.getVoluntariadoMembers(currentVolunteerId);
        showAssignAchievementModal(achievementId, members);
        
    } catch (error) {
        console.error('‚ùå Error preparando asignaci√≥n de logro:', error);
        showMessage('Error al preparar asignaci√≥n: ' + error.message, 'danger');
    }
}

async function deleteAchievement(achievementId) {
    try {
        console.log('üóëÔ∏è Eliminar logro:', achievementId);
        
        if (!window.adminManager) {
            showMessage('AdminManager no est√° disponible', 'danger');
            return;
        }
        
        // Confirmar eliminaci√≥n
        if (!confirm('¬øEst√°s seguro de que quieres eliminar este logro? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        await window.adminManager.deleteAchievement(achievementId);
        showMessage('Logro eliminado exitosamente', 'success');
        
        // Recargar logros
        await loadAchievementsData();
        
    } catch (error) {
        console.error('‚ùå Error eliminando logro:', error);
        showMessage('Error al eliminar logro: ' + error.message, 'danger');
    }
}

function exportMembersData() {
    // Implementar exportaci√≥n de datos
    console.log('Exportando datos de miembros...');
    showMessage('Funci√≥n de exportaci√≥n pr√≥ximamente', 'info');
}

// FUNCI√ìN DE DEBUGGING: Recargar logros manualmente
async function debugReloadAchievements() {
    try {
        console.log('üîç DEBUGGING: Recargando logros...');
        console.log('Voluntariado actual:', currentVolunteerId);
        
        // Ver todos los logros en Firestore
        const allAchievements = await window.debugAchievements();
        console.log('üìä Todos los logros en Firestore:', allAchievements);
        
        // Recargar logros del voluntariado actual
        await loadAchievementsData();
        
        showMessage('Logros recargados. Revisa la consola para m√°s detalles.', 'info');
        
    } catch (error) {
        console.error('‚ùå Error en debug:', error);
        showMessage('Error en debugging: ' + error.message, 'danger');
    }
}

function showHoursHistoryModal(historyData) {
    const modal = document.createElement('div');
    modal.className = 'modal is-active';
    modal.innerHTML = `
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card" style="width: 90%; max-width: 800px;">
            <header class="modal-card-head">
                <p class="modal-card-title">
                    <span class="icon"><i class="fas fa-history"></i></span>
                    Historial de Horas - ${historyData.memberInfo.firstName} ${historyData.memberInfo.lastName}
                </p>
                <button class="delete" onclick="closeModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="has-text-centered mb-4">
                    <h3 class="title is-4">Total de Horas: ${historyData.totalHours}h</h3>
                </div>
                
                ${historyData.history.length === 0 ? `
                    <div class="has-text-centered py-6">
                        <i class="fas fa-clock fa-3x has-text-grey-light"></i>
                        <p class="has-text-grey mt-3">No hay registro de horas para este miembro</p>
                    </div>
                ` : `
                    <div class="table-container">
                        <table class="table is-fullwidth is-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Actividad</th>
                                    <th>Horas</th>
                                    <th>Comentarios</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${historyData.history.map(entry => {
                                    // Manejar diferentes formatos de fecha
                                    let dateStr = 'Fecha no disponible';
                                    try {
                                        if (entry.date && typeof entry.date.toLocaleDateString === 'function') {
                                            dateStr = entry.date.toLocaleDateString();
                                        } else if (entry.date && typeof entry.date === 'string') {
                                            dateStr = new Date(entry.date).toLocaleDateString();
                                        } else if (entry.addedAt && typeof entry.addedAt.toLocaleDateString === 'function') {
                                            dateStr = entry.addedAt.toLocaleDateString();
                                        } else if (entry.addedAt && typeof entry.addedAt === 'string') {
                                            dateStr = new Date(entry.addedAt).toLocaleDateString();
                                        }
                                    } catch (error) {
                                        console.warn('Error formateando fecha:', error);
                                        dateStr = 'Fecha inv√°lida';
                                    }
                                    
                                    return `
                                        <tr>
                                            <td>${dateStr}</td>
                                            <td><strong>${entry.event || entry.activity || 'Actividad'}</strong></td>
                                            <td><span class="tag is-primary">${entry.hours}h</span></td>
                                            <td>${entry.comments || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal()">Cerrar</button>
            </footer>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Modal para mostrar detalles del logro
function showAchievementDetailsModal(achievementDetails) {
    const modal = document.createElement('div');
    modal.className = 'modal is-active';
    modal.innerHTML = `
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card" style="width: 90%; max-width: 800px;">
            <header class="modal-card-head">
                <p class="modal-card-title">
                    <span class="icon"><i class="fas fa-trophy"></i></span>
                    ${achievementDetails.name}
                </p>
                <button class="delete" onclick="closeModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="columns">
                    <div class="column is-one-third">
                        <div class="has-text-centered">
                            <div class="achievement-icon-large">
                                <i class="${achievementDetails.icon || 'fas fa-trophy'} fa-4x has-text-warning"></i>
                            </div>
                            <p class="title is-5 mt-3">${achievementDetails.name}</p>
                        </div>
                    </div>
                    <div class="column">
                        <div class="content">
                            <h4 class="title is-6">Descripci√≥n</h4>
                            <p>${achievementDetails.description || 'Sin descripci√≥n'}</p>
                            
                            <h4 class="title is-6 mt-4">Requisitos</h4>
                            <p>${achievementDetails.requirements || 'Sin requisitos espec√≠ficos'}</p>
                            
                            <h4 class="title is-6 mt-4">Estado</h4>
                            <span class="tag ${achievementDetails.isActive ? 'is-success' : 'is-danger'}">
                                ${achievementDetails.isActive ? 'Activo' : 'Inactivo'}
                            </span>
                            
                            <h4 class="title is-6 mt-4">Horas del Logro</h4>
                            <p class="has-text-primary">
                                <span class="icon"><i class="fas fa-clock"></i></span>
                                <strong>${achievementDetails.hours || 0} horas</strong>
                            </p>
                            
                            <h4 class="title is-6 mt-4">Fecha de Creaci√≥n</h4>
                            <p>${achievementDetails.createdAt ? achievementDetails.createdAt.toDate().toLocaleDateString() : 'No disponible'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5">
                    <h4 class="title is-6">Miembros Asignados (${achievementDetails.assignedMembers.length})</h4>
                    ${achievementDetails.assignedMembers.length === 0 ? `
                        <div class="has-text-centered py-4">
                            <i class="fas fa-users fa-2x has-text-grey-light"></i>
                            <p class="has-text-grey mt-2">Ning√∫n miembro tiene este logro asignado</p>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table class="table is-fullwidth is-striped">
                                <thead>
                                    <tr>
                                        <th>Miembro</th>
                                        <th>Email</th>
                                        <th>Horas Obtenidas</th>
                                        <th>Asignado el</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${achievementDetails.assignedMembers.map(member => `
                                        <tr>
                                            <td>
                                                <div class="is-flex is-align-items-center">
                                                    <figure class="image is-24x24 mr-2">
                                                        <div class="is-rounded has-background-primary" style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                            <span class="has-text-white is-size-7">
                                                                ${member.name.charAt(0).toUpperCase()}
                                                            </span>
                                                        </div>
                                                    </figure>
                                                    ${member.name}
                                                </div>
                                            </td>
                                            <td>${member.email}</td>
                                            <td>
                                                <span class="tag is-success">
                                                    <span class="icon"><i class="fas fa-clock"></i></span>
                                                    <span>${member.achievementHours || 0}h</span>
                                                </span>
                                            </td>
                                            <td>${member.assignedAt ? member.assignedAt.toDate().toLocaleDateString() : 'No disponible'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-warning" onclick="assignAchievement('${achievementDetails.id}')">
                    <span class="icon"><i class="fas fa-user-plus"></i></span>
                    <span>Asignar a Miembro</span>
                </button>
                <button class="button is-danger" onclick="deleteAchievement('${achievementDetails.id}')">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                    <span>Eliminar</span>
                </button>
                <button class="button" onclick="closeModal()">Cerrar</button>
            </footer>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Modal para asignar logro a un miembro
async function showAssignAchievementModal(achievementId, members) {
    try {
        // Obtener detalles del logro para mostrar las horas
        const achievementDetails = await window.adminManager.getAchievementDetails(achievementId);
        
        // Filtrar miembros que ya tienen este logro
        // Por ahora mostramos todos los miembros, la verificaci√≥n real se hace en el backend
        const availableMembers = members;

        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background" onclick="closeModal()"></div>
            <div class="modal-card" style="width: 90%; max-width: 600px;">
                <header class="modal-card-head">
                    <p class="modal-card-title">
                        <span class="icon"><i class="fas fa-user-plus"></i></span>
                        Asignar Logro: ${achievementDetails.name}
                    </p>
                    <button class="delete" onclick="closeModal()"></button>
                </header>
                <section class="modal-card-body">
                    <div class="notification is-info is-light">
                        <p><strong>Horas del logro:</strong> ${achievementDetails.hours || 0} horas</p>
                        <p class="is-size-7">Estas horas se sumar√°n autom√°ticamente al total del miembro</p>
                    </div>
                    
                    <div class="field">
                        <label class="label">Seleccionar Miembro</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="member-select">
                                    <option value="">Selecciona un miembro...</option>
                                    ${availableMembers.map(member => `
                                        <option value="${member.uid || member.id}">
                                            ${member.firstName || ''} ${member.lastName || ''} - ${member.email}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        ${availableMembers.length === 0 ? `
                            <p class="help is-warning">
                                <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                                Todos los miembros ya tienen este logro asignado
                            </p>
                        ` : `
                            <p class="help">${availableMembers.length} miembros disponibles</p>
                        `}
                    </div>
                    
                    <div class="field">
                        <label class="label">Comentarios (Opcional)</label>
                        <div class="control">
                            <textarea class="textarea" id="assignment-comments" placeholder="Comentarios sobre la asignaci√≥n del logro..."></textarea>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-success" onclick="confirmAssignAchievement('${achievementId}')" ${availableMembers.length === 0 ? 'disabled' : ''}>
                        <span class="icon"><i class="fas fa-check"></i></span>
                        <span>Asignar Logro</span>
                    </button>
                    <button class="button" onclick="closeModal()">Cancelar</button>
                </footer>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error mostrando modal de asignaci√≥n:', error);
        showMessage('Error al mostrar modal de asignaci√≥n: ' + error.message, 'danger');
    }
}

// Confirmar asignaci√≥n de logro
async function confirmAssignAchievement(achievementId) {
    try {
        const memberSelect = document.getElementById('member-select');
        const comments = document.getElementById('assignment-comments').value;
        
        if (!memberSelect.value) {
            showMessage('Por favor selecciona un miembro', 'warning');
            return;
        }
        
        if (!currentVolunteerId) {
            showMessage('No hay voluntariado seleccionado', 'warning');
            return;
        }
        
        if (!window.adminManager) {
            showMessage('AdminManager no est√° disponible', 'danger');
            return;
        }
        
        await window.adminManager.assignAchievementToMember(memberSelect.value, currentVolunteerId, achievementId);
        showMessage('Logro asignado exitosamente', 'success');
        
        closeModal();
        
        // Recargar logros para mostrar los cambios
        await loadAchievementsData();
        
    } catch (error) {
        console.error('‚ùå Error asignando logro:', error);
        showMessage('Error al asignar logro: ' + error.message, 'danger');
    }
}

// Exponer funci√≥n de debugging globalmente
window.debugReloadAchievements = debugReloadAchievements;

// Funci√≥n de debugging completa para el panel de administraci√≥n
window.debugAdminPanel = async function() {
    console.log('üîç === DEBUGGING COMPLETO DEL PANEL ADMIN ===');
    
    // 1. Verificar AdminManager
    console.log('1. Verificando AdminManager...');
    console.log('AdminManager disponible:', !!window.adminManager);
    console.log('getHoursByActivity:', typeof window.adminManager?.getHoursByActivity);
    console.log('getVolunteerAchievements:', typeof window.adminManager?.getVolunteerAchievements);
    console.log('addHoursToMember:', typeof window.adminManager?.addHoursToMember);
    
    // 2. Verificar voluntariado actual
    console.log('2. Voluntariado actual:', currentVolunteerId);
    
    // 3. Verificar todos los logros en Firestore
    console.log('3. Verificando logros en Firestore...');
    try {
        const allAchievements = await window.debugAchievements();
        console.log('Total logros en Firestore:', allAchievements.length);
        
        // Filtrar logros del voluntariado actual
        const currentVolunteerAchievements = allAchievements.filter(a => a.voluntariadoId === currentVolunteerId);
        console.log('Logros del voluntariado actual:', currentVolunteerAchievements.length);
        currentVolunteerAchievements.forEach(a => {
            console.log(`üèÜ ${a.name} (${a.id}) - Activo: ${a.isActive}`);
        });
    } catch (error) {
        console.error('Error obteniendo logros:', error);
    }
    
    // 4. Verificar datos de miembros
    console.log('4. Datos de miembros:', membersData?.length || 0);
    
    // 5. Recargar logros
    console.log('5. Recargando logros...');
    await loadAchievementsData();
    
    console.log('‚úÖ Debugging completo terminado');
};

// Funci√≥n espec√≠fica para debugging del historial de horas
window.debugHoursHistory = async function(memberId) {
    console.log('üîç === DEBUGGING HISTORIAL DE HORAS ===');
    
    if (!memberId) {
        console.error('‚ùå No se proporcion√≥ memberId');
        return;
    }
    
    try {
        console.log('1. Verificando AdminManager...');
        console.log('AdminManager disponible:', !!window.adminManager);
        console.log('getMemberHoursHistory:', typeof window.adminManager?.getMemberHoursHistory);
        
        console.log('2. Voluntariado actual:', currentVolunteerId);
        
        console.log('3. Obteniendo historial de horas...');
        const historyData = await window.adminManager.getMemberHoursHistory(memberId, currentVolunteerId);
        
        console.log('‚úÖ Historial obtenido exitosamente:');
        console.log('Total horas:', historyData.totalHours);
        console.log('N√∫mero de entradas:', historyData.history.length);
        console.log('Informaci√≥n del miembro:', historyData.memberInfo);
        console.log('Historial completo:', historyData.history);
        
        // Mostrar modal con el historial
        showHoursHistoryModal(historyData);
        
    } catch (error) {
        console.error('‚ùå Error en debugging de historial:', error);
        console.error('Stack trace:', error.stack);
    }
};
</script>

<style>
/* Estilos para el Panel de Administraci√≥n */
.admin-panel-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
}

.panel-header {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
}

.header-info h1 {
    color: #2989d8;
    margin-bottom: 0.5rem;
}

.header-stats {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.stat-card {
    background: linear-gradient(135deg, #2989d8, #18559b);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 150px;
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.volunteer-selector {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.panel-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.tab-content {
    margin-top: 2rem;
}

.members-header, .statistics-header, .hours-header, .achievements-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
}

.member-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid #2989d8;
    transition: transform 0.2s ease;
}

.member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.member-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.member-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #2989d8, #18559b);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.member-details h4 {
    margin-bottom: 0.25rem;
    color: #2c3e50;
}

.member-details .subtitle {
    color: #7f8c8d;
    margin-bottom: 0.5rem;
}

.member-stats {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.member-actions {
    display: flex;
    gap: 0.5rem;
}

.hours-member-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid #28a745;
    transition: transform 0.2s ease;
}

.hours-member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.hours-member-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.hours-member-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.hours-member-details h4 {
    margin-bottom: 0.25rem;
    color: #2c3e50;
}

.hours-member-details .subtitle {
    color: #7f8c8d;
    margin-bottom: 0.5rem;
}

.hours-member-stats {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.hours-member-actions {
    display: flex;
    gap: 0.5rem;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chart-container.full-width {
    grid-column: 1 / -1;
}

.chart-header {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.chart-content {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.table-container {
    max-height: 400px;
    overflow-y: auto;
}

.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.achievement-card {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.achievement-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border-color: #2989d8;
}

.achievement-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.achievement-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #2989d8, #18559b);
    border-radius: 50%;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.achievement-info h4 {
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.achievement-info .subtitle {
    color: #7f8c8d;
    margin-bottom: 0;
}

.achievement-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.achievement-actions {
    display: flex;
    gap: 0.5rem;
}

.notification {
    margin-bottom: 1rem;
    border-radius: 8px;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-panel-container {
        padding: 1rem;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .header-stats {
        justify-content: center;
    }
    
    .member-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .member-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .hours-member-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .hours-member-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

/* Estilos para funcionalidades de logros */
.achievement-icon-large {
    margin-bottom: 1rem;
}

.achievement-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.achievement-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-start;
}

.achievement-actions .button {
    flex: 0 0 auto;
}

/* Estilos para modales de logros */
.achievement-details-modal .columns {
    margin-bottom: 1.5rem;
}

.achievement-details-modal .achievement-icon-large {
    text-align: center;
    margin-bottom: 1rem;
}

.achievement-details-modal .content h4 {
    margin-bottom: 0.5rem;
}

.achievement-details-modal .table-container {
    max-height: 300px;
    overflow-y: auto;
}

/* Estilos para modal de asignaci√≥n */
.assign-achievement-modal .field {
    margin-bottom: 1.5rem;
}

.assign-achievement-modal .select {
    width: 100%;
}

.assign-achievement-modal .textarea {
    min-height: 100px;
}

/* Responsive para funcionalidades de logros */
@media (max-width: 768px) {
    .achievement-actions {
        justify-content: center;
    }
    
    .achievement-actions .button {
        flex: 1;
        min-width: 0;
    }
    
    .achievement-meta {
        justify-content: center;
    }
}
</style>
{% endblock %}